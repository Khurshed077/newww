<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Blog</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&family=Open+Sans&display=swap" rel="stylesheet">

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<!-- Materialize CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

<style>
body { background-color: #121212; font-family: 'Open Sans', sans-serif; color: #E0E0E0; }
a { text-decoration: none; color: #FFD600; transition: color 0.3s; }
a:hover { color: #FFEA00; }

/* NAVBAR */
nav {
    background: rgba(30, 30, 30, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}
nav a { color: #FFD600 !important; font-weight: 500; }
.brand-logo { font-family: 'Roboto', sans-serif; font-weight: 700; color: #FFD600 !important; }
.btn-glass {
    background: rgba(255, 214, 0, 0.15);
    color: #FFD600;
    border-radius: 999px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.2s;
}
.btn-glass:hover { background: rgba(255, 214, 0, 0.3); color: #FFF700; }

/* Cards */
.card {
    border-radius: 18px;
    background: rgba(40, 40, 40, 0.85);
    backdrop-filter: blur(12px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.6);
    margin-bottom: 24px;
    color: #E0E0E0;
}
.card-title { font-family: 'Roboto', sans-serif; font-weight: 700; color: #FFD600; font-size: 1.4rem; }
.card-content p { color: #CCCCCC; }
.card-image img { border-radius: 18px 18px 0 0; max-height: 220px; object-fit: cover; }

/* Categories */
.collection {
    border-radius: 16px;
    background: rgba(40, 40, 40, 0.85);
    padding: 8px;
}
.collection-item { background: transparent; color: #FFD600; transition: all 0.2s; }
.collection-item:hover { background: rgba(255, 214, 0, 0.15); }
</style>
</head>

<body>
<!-- NAVBAR -->
<nav>
    <div class="nav-wrapper container">
        <a href="/" class="brand-logo">MyBlog</a>
        <a href="#" data-target="mobile-menu" class="sidenav-trigger">
            <i class="material-icons">menu</i>
        </a>
        <ul class="right hide-on-med-and-down" id="navbar-links">
            <li><a href="/login">Авторизация</a></li>
            <li><a href="/register" class="btn btn-glass">Регистрация</a></li>
        </ul>
    </div>
</nav>

<!-- MOBILE MENU -->
<ul class="sidenav" id="mobile-menu">
    <li><a href="/login">Авторизация</a></li>
    <li><a href="/register">Регистрация</a></li>
</ul>

<div class="container" style="margin-top: 32px;">
    <div class="row">
        <!-- Categories desktop -->
        <div class="col s12 m3 hide-on-small-only">
            <ul class="collection" id="categories-container"></ul>
        </div>

        <!-- Articles -->
        <div class="col s12 m9" id="articles-container"></div>
    </div>
</div>

<!-- Materialize JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        M.Sidenav.init(document.querySelectorAll('.sidenav'));
    });
    
    const articlesPerPage = 4;
    let currentPage = 1;
    let allArticles = [];
    let currentCategory = null;
    
    // Авто-login через refresh token и обновление меню
    async function checkAutoLogin() {
        try {
            const res = await fetch("/api/refresh", { method: "POST", credentials: "include" });
            if (res.ok) {
                const navbar = document.getElementById("navbar-links");
                if (navbar) {
                    navbar.innerHTML = `
                        <li><a href="/dashboard" class="btn btn-glass">Dashboard</a></li>
                        <li><a href="/logout">Выйти</a></li>
                    `;
                }
                const mobile = document.getElementById("mobile-menu");
                if (mobile) {
                    mobile.innerHTML = `
                        <li><a href="/dashboard">Dashboard</a></li>
                        <li><a href="/logout">Выйти</a></li>
                    `;
                }
                return true;
            }
        } catch (e) {
            console.log("Auto-login failed:", e);
        }
        return false;
    }
    
    // Загрузка статей и категорий
    async function loadHome(categoryID = null) {
        currentCategory = categoryID;
        let url = "/api/home";
        if (categoryID) url += `?category_id=${categoryID}`;
    
        const res = await fetch(url, { credentials: "include" });
        if (!res.ok) {
            console.error("Failed to load articles");
            return;
        }
    
        const data = await res.json();
        allArticles = data.articles;
        currentPage = 1;
    
        renderArticles();
        renderPagination();
        renderCategories(data.categories);
    }
    
    // Отрисовка статей с учетом пагинации
    function renderArticles() {
        const container = document.getElementById("articles-container");
        container.innerHTML = "";
    
        if (allArticles.length === 0) {
            container.innerHTML = `<p style="color:#CCCCCC;">У тебя нет записей.</p>`;
            return;
        }
    
        const start = (currentPage - 1) * articlesPerPage;
        const end = start + articlesPerPage;
        const pageArticles = allArticles.slice(start, end);
    
        pageArticles.forEach(article => {
            const card = document.createElement("div");
            card.className = "card hoverable";
            card.innerHTML = `
                ${article.image ? `<div class="card-image"><img src="/uploads/${article.image}" class="responsive-img"></div>` : ""}
                <div class="card-content">
                    <span class="card-title">${article.title}</span>
                    <p>${article.anons}</p>
                </div>
                <div class="card-action">
                    <a href="/articles/detail?id=${article.id}">Read more →</a>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    // Отрисовка пагинации
    function renderPagination() {
        let pagination = document.getElementById("pagination");
        if (!pagination) {
            pagination = document.createElement("div");
            pagination.id = "pagination";
            pagination.style.marginTop = "20px";
            pagination.style.textAlign = "center";
            document.querySelector(".container").appendChild(pagination);
        }
        pagination.innerHTML = "";
    
        const totalPages = Math.ceil(allArticles.length / articlesPerPage);
    
        // Previous
        const prevBtn = document.createElement("button");
        prevBtn.className = "btn btn-glass";
        prevBtn.textContent = "Previous";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            currentPage--;
            renderArticles();
            renderPagination();
        };
        pagination.appendChild(prevBtn);
    
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.className = "btn btn-glass";
            pageBtn.style.margin = "0 4px";
            pageBtn.textContent = i;
            if (i === currentPage) {
                pageBtn.style.background = "#FFD600";
                pageBtn.style.color = "#121212";
            }
            pageBtn.onclick = () => {
                currentPage = i;
                renderArticles();
                renderPagination();
            };
            pagination.appendChild(pageBtn);
        }
    
        // Next
        const nextBtn = document.createElement("button");
        nextBtn.className = "btn btn-glass";
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
            currentPage++;
            renderArticles();
            renderPagination();
        };
        pagination.appendChild(nextBtn);
    }
    
    // Отрисовка категорий
    function renderCategories(categories) {
        const catContainer = document.getElementById("categories-container");
        catContainer.innerHTML = "";
    
        const allLi = document.createElement("li");
        allLi.className = "collection-item";
        allLi.innerHTML = `<a href="#">Все статьи</a>`;
        allLi.querySelector("a").addEventListener("click", (e) => {
            e.preventDefault();
            loadHome();
        });
        catContainer.appendChild(allLi);
    
        categories.forEach(cat => {
            const li = document.createElement("li");
            li.className = "collection-item";
            li.innerHTML = `<a href="#" data-id="${cat.id}">${cat.name}</a>`;
            li.querySelector("a").addEventListener("click", (e) => {
                e.preventDefault();
                loadHome(cat.id);
            });
            catContainer.appendChild(li);
        });
    }
    
    // Инициализация
    (async function init() {
        await checkAutoLogin();
        await loadHome();
    })();
    </script>
    

</body>
</html>
